WeaponNames = {
    [tostring(GetHashKey('WEAPON_KNIFE'))] = 'weapon_knife',
    [tostring(GetHashKey('WEAPON_NIGHTSTICK'))] = 'weapon_nightstick',
    [tostring(GetHashKey('WEAPON_HAMMER'))] = 'weapon_hammer',
    [tostring(GetHashKey('WEAPON_BAT'))] = 'weapon_bat',
    [tostring(GetHashKey('WEAPON_GOLFCLUB'))] = 'weapon_golfclub',
    [tostring(GetHashKey('WEAPON_CROWBAR'))] = 'weapon_crowbar',
    [tostring(GetHashKey('WEAPON_PISTOL'))] = 'weapon_pistol',
    [tostring(GetHashKey('WEAPON_COMBATPISTOL'))] = 'weapon_combatpistol',
    [tostring(GetHashKey('WEAPON_APPISTOL'))] = 'weapon_appistol',
    [tostring(GetHashKey('WEAPON_PISTOL50'))] = 'weapon_pistol50',
    [tostring(GetHashKey('WEAPON_MICROSMG'))] = 'weapon_microsmg',
    [tostring(GetHashKey('WEAPON_SMG'))] = 'weapon_smg',
    [tostring(GetHashKey('WEAPON_ASSAULTSMG'))] = 'weapon_assaultsmg',
    [tostring(GetHashKey('WEAPON_ASSAULTRIFLE'))] = 'weapon_assaultrifle',
    [tostring(GetHashKey('WEAPON_CARBINERIFLE'))] = 'weapon_carbinerifle',
    [tostring(GetHashKey('WEAPON_ADVANCEDRIFLE'))] = 'weapon_advancedrifle',
    [tostring(GetHashKey('WEAPON_MG'))] = 'weapon_mg',
    [tostring(GetHashKey('WEAPON_COMBATMG'))] = 'weapon_combatmg',
    [tostring(GetHashKey('WEAPON_PUMPSHOTGUN'))] = 'weapon_pumpshotgun',
    [tostring(GetHashKey('WEAPON_SAWNOFFSHOTGUN'))] = 'weapon_sawnoffshotgun',
    [tostring(GetHashKey('WEAPON_ASSAULTSHOTGUN'))] = 'weapon_assaultshotgun',
    [tostring(GetHashKey('WEAPON_BULLPUPSHOTGUN'))] = 'weapon_bullpupshotgun',
    [tostring(GetHashKey('WEAPON_STUNGUN'))] = 'weapon_stungun',
    [tostring(GetHashKey('WEAPON_SNIPERRIFLE'))] = 'weapon_sniperrifle',
    [tostring(GetHashKey('WEAPON_HEAVYSNIPER_MK2'))] = 'weapon_heavysniper_mk2',
    [tostring(GetHashKey('WEAPON_REMOTESNIPER'))] = 'weapon_remotesniper',
    [tostring(GetHashKey('WEAPON_GRENADELAUNCHER'))] = 'weapon_grenadelauncher',
    [tostring(GetHashKey('WEAPON_GRENADELAUNCHER_SMOKE'))] = 'weapon_grenadelauncher_smoke',
    [tostring(GetHashKey('WEAPON_RPG'))] = 'weapon_rpg',
    [tostring(GetHashKey('WEAPON_PASSENGER_ROCKET'))] = 'weapon_passenger_rocket',
    [tostring(GetHashKey('WEAPON_AIRSTRIKE_ROCKET'))] = 'weapon_airstrike_rocket',
    [tostring(GetHashKey('WEAPON_STINGER'))] = 'weapon_stinger',
    [tostring(GetHashKey('WEAPON_MINIGUN'))] = 'weapon_minigun',
    [tostring(GetHashKey('WEAPON_GRENADE'))] = 'weapon_grenade',
    [tostring(GetHashKey('WEAPON_STICKYBOMB'))] = 'weapon_stickybomb',
    [tostring(GetHashKey('WEAPON_SMOKEGRENADE'))] = 'weapon_smokegrenade',
    [tostring(GetHashKey('WEAPON_BZGAS'))] = 'weapon_bzgas',
    [tostring(GetHashKey('WEAPON_MOLOTOV'))] = 'weapon_molotov',
    [tostring(GetHashKey('WEAPON_FIREEXTINGUISHER'))] = 'weapon_fireextinguisher',
    [tostring(GetHashKey('WEAPON_PETROLCAN'))] = 'weapon_petrolcan',
    [tostring(GetHashKey('OBJECT'))] = 'object',
    [tostring(GetHashKey('WEAPON_BALL'))] = 'weapon_ball',
    [tostring(GetHashKey('WEAPON_FLARE'))] = 'weapon_flare',
    [tostring(GetHashKey('VEHICLE_WEAPON_TANK'))] = 'weapon_tankcannon',
    [tostring(GetHashKey('VEHICLE_WEAPON_SPACE_ROCKET'))] = 'weapon_rockets',
    [tostring(GetHashKey('VEHICLE_WEAPON_PLAYER_LASER'))] = 'weapon_laser',
    [tostring(GetHashKey('AMMO_RPG'))] = 'weapon_rpg',
    [tostring(GetHashKey('AMMO_TANK'))] = 'weapon_tankcannon',
    [tostring(GetHashKey('AMMO_SPACE_ROCKET'))] = 'weapon_rockets',
    [tostring(GetHashKey('AMMO_PLAYER_LASER'))] = 'weapon_laser',
    [tostring(GetHashKey('AMMO_ENEMY_LASER'))] = 'weapon_laser',
    [tostring(GetHashKey('WEAPON_RAMMED_BY_CAR'))] = 'weapon_rammedbycar',
    [tostring(GetHashKey('WEAPON_BOTTLE'))] = 'weapon_bottle',
    [tostring(GetHashKey('WEAPON_GUSENBERG'))] = 'weapon_gusenberg',
    [tostring(GetHashKey('WEAPON_SNSPISTOL'))] = 'weapon_snspistol',
    [tostring(GetHashKey('WEAPON_VINTAGEPISTOL'))] = 'weapon_vintagepistol', 
    [tostring(GetHashKey('WEAPON_DAGGER'))] = 'weapon_antique_cavalry_dagger',
    [tostring(GetHashKey('WEAPON_FLAREGUN'))] = 'weapon_flaregun',
    [tostring(GetHashKey('WEAPON_HEAVYPISTOL'))] = 'weapon_heavypistol',
    [tostring(GetHashKey('WEAPON_SPECIALCARBINE'))] = 'weapon_specialcarbine',
    [tostring(GetHashKey('WEAPON_SPECIALCARBINE_MK2'))] = 'weapon_specialcarbine_mk2',
    [tostring(GetHashKey('WEAPON_MUSKET'))] = 'weapon_musket',
    [tostring(GetHashKey('WEAPON_FIREWORK'))] = 'weapon_firework',
    [tostring(GetHashKey('WEAPON_MARKSMANRIFLE'))] = 'weapon_marksmanrifle',
    [tostring(GetHashKey('WEAPON_MARKSMANRIFLE_MK2'))] = 'weapon_marksmanrifle_mk2',
    [tostring(GetHashKey('WEAPON_HEAVYSNIPER'))] = 'weapon_heavysniper',
    [tostring(GetHashKey('WEAPON_PROXMINE'))] = 'weapon_proxmine',
    [tostring(GetHashKey('WEAPON_HOMINGLAUNCHER'))] = 'weapon_hominglauncher',
    [tostring(GetHashKey('WEAPON_HATCHET'))] = 'weapon_hatchet',
    [tostring(GetHashKey('WEAPON_COMBATPDW'))] = 'weapon_combatpdw',
    [tostring(GetHashKey('WEAPON_KNUCKLE'))] = 'weapon_knuckle',
    [tostring(GetHashKey('WEAPON_MARKSMANPISTOL'))] = 'weapon_marksmanpistol',
    [tostring(GetHashKey('WEAPON_MACHETE'))] = 'weapon_machete',
    [tostring(GetHashKey('WEAPON_MACHINEPISTOL'))] = 'weapon_machinepistol',
    [tostring(GetHashKey('WEAPON_FLASHLIGHT'))] = 'weapon_flashlight',
    [tostring(GetHashKey('WEAPON_DBSHOTGUN'))] = 'weapon_dbshotgun',
    [tostring(GetHashKey('WEAPON_COMPACTRIFLE'))] = 'weapon_compactrifle',
    [tostring(GetHashKey('WEAPON_SWITCHBLADE'))] = 'weapon_switchblade',
    [tostring(GetHashKey('WEAPON_REVOLVER'))] = 'weapon_revolver',
    [tostring(GetHashKey('WEAPON_FIRE'))] = 'weapon_fire',
    [tostring(GetHashKey('WEAPON_HELI_CRASH'))] = 'weapon_heli_crash',
    [tostring(GetHashKey('WEAPON_RUN_OVER_BY_CAR'))] = 'weapon_run_over_by_car',
    [tostring(GetHashKey('WEAPON_HIT_BY_WATER_CANNON'))] = 'weapon_hit_by_water_cannon',
    [tostring(GetHashKey('WEAPON_EXHAUSTION'))] = 'weapon_exhaustion',
    [tostring(GetHashKey('WEAPON_EXPLOSION'))] = 'weapon_explosion',
    [tostring(GetHashKey('WEAPON_ELECTRIC_FENCE'))] = 'weapon_electric_fence',
    [tostring(GetHashKey('WEAPON_BLEEDING'))] = 'weapon_bleeding',
    [tostring(GetHashKey('WEAPON_DROWNING_IN_VEHICLE'))] = 'weapon_drowning_in_vehicle',
    [tostring(GetHashKey('WEAPON_DROWNING'))] = 'weapon_drowning',
    [tostring(GetHashKey('WEAPON_BARBED_WIRE'))] = 'weapon_barbed_wire',
    [tostring(GetHashKey('WEAPON_VEHICLE_ROCKET'))] = 'weapon_vehicle_rocket',
    [tostring(GetHashKey('WEAPON_BULLPUPRIFLE'))] = 'weapon_bullpuprifle',
    [tostring(GetHashKey('WEAPON_ASSAULTSNIPER'))] = 'weapon_assaultsniper',
    [tostring(GetHashKey('VEHICLE_WEAPON_ROTORS'))] = 'weapon_rotors',
    [tostring(GetHashKey('WEAPON_RAILGUN'))] = 'weapon_railgun',
    [tostring(GetHashKey('WEAPON_AIR_DEFENCE_GUN'))] = 'weapon_air_defence_gun',
    [tostring(GetHashKey('WEAPON_AUTOSHOTGUN'))] = 'weapon_autoshotgun',
    [tostring(GetHashKey('WEAPON_BATTLEAXE'))] = 'weapon_battleaxe',
    [tostring(GetHashKey('WEAPON_COMPACTLAUNCHER'))] = 'weapon_compactlauncher',
    [tostring(GetHashKey('WEAPON_MINISMG'))] = 'weapon_minismg',
    [tostring(GetHashKey('WEAPON_PIPEBOMB'))] = 'weapon_pipebomb',
    [tostring(GetHashKey('WEAPON_ASSAULTRIFLE_MK2'))] = 'weapon_assaultrifle_mk2',
    [tostring(GetHashKey('WEAPON_PISTOL_MK2'))] = 'weapon_pistol_mk2',
    [tostring(GetHashKey('WEAPON_SMG_MK2'))] = 'weapon_smg_mk2',
    [tostring(GetHashKey('WEAPON_COMBATMG_MK2'))] = 'weapon_combatmg_mk2',
    [tostring(GetHashKey('WEAPON_PUMPSHOTGUN_MK2'))] = 'weapon_pumpshotgun_mk2',
    [tostring(GetHashKey('WEAPON_SNSPISTOL_MK2'))] = 'weapon_snspistol_mk2',
    [tostring(GetHashKey('WEAPON_REVOLVER_MK2'))] = 'weapon_revolver_mk2',
    [tostring(GetHashKey('WEAPON_BULLPUPRIFLE_MK2'))] = 'weapon_bullpuprifle_mk2',
    [tostring(GetHashKey('WEAPON_CARBINERIFLE_MK2'))] = 'weapon_carbinerifle_mk2',
    [tostring(GetHashKey('WEAPON_MILITARYRIFLE'))] = 'weapon_militaryrifle',
    [tostring(GetHashKey('WEAPON_COMBATSHOTGUN'))] = 'weapon_combatshotgun',
    [tostring(GetHashKey('WEAPON_GADGETPISTOL'))] = 'weapon_gadgetpistol',
    [tostring(GetHashKey('WEAPON_NAVYREVOLVER'))] = 'weapon_navyrevolver',
    [tostring(GetHashKey('WEAPON_CERAMICPISTOL'))] = 'weapon_ceramicpistol',
    [tostring(GetHashKey('WEAPON_HAZARDCAN'))] = 'weapon_hazardcan',
    [tostring(GetHashKey('WEAPON_STONE_HATCHET'))] = 'weapon_stone_hatchet',
    [tostring(GetHashKey('WEAPON_PRECISIONRIFLE'))] = 'weapon_precisionrifle',
    [tostring(GetHashKey('WEAPON_STUNGUN_MP'))] = 'weapon_stungun_mp',
    [tostring(GetHashKey('WEAPON_PISTOLXM3'))] = 'weapon_pistolxm3',
    [tostring(GetHashKey('WEAPON_CANDYCANE'))] = 'weapon_candycane',
    [tostring(GetHashKey('WEAPON_POOLCUE'))] = 'weapon_poolcue',
    [tostring(GetHashKey('WEAPON_WRENCH'))] = 'weapon_wrench',
    [tostring(GetHashKey('WEAPON_FERTILIZERCAN'))] = 'weapon_fertilizercan',
    [tostring(GetHashKey('WEAPON_RAYMINIGUN'))] = 'weapon_rayminigun',
    [tostring(GetHashKey('WEAPON_RAYPISTOL'))] = 'weapon_raypistol',
    [tostring(GetHashKey('WEAPON_RAYCARBINE'))] = 'weapon_raycarbine',
    [tostring(GetHashKey('WEAPON_EMPLAUNCHER'))] = 'weapon_emplauncher',
    [tostring(GetHashKey('WEAPON_METALDETECTOR'))] = 'weapon_metaldetector',
    [tostring(GetHashKey('WEAPON_DIGISCANNER'))] = 'weapon_digiscanner',
    [tostring(GetHashKey('WEAPON_SNOWBALL'))] = 'weapon_snowball',
    [tostring(GetHashKey('WEAPON_PARACHUTE'))] = 'weapon_parachute',
    [tostring(GetHashKey('WEAPON_ANIMAL'))] = 'weapon_animal',
    [tostring(GetHashKey('WEAPON_COUGAR'))] = 'weapon_cougar',
    [tostring(GetHashKey('WEAPON_BULLPUPRIFLE_MK2'))] = 'weapon_bullpuprifle_mk2',
    [tostring(GetHashKey('WEAPON_TACTICALRIFLE'))] = 'weapon_tacticalrifle',
    [tostring(GetHashKey('WEAPON_HEAVYSHOTGUN'))] = 'weapon_heavyshotgun',
    [tostring(GetHashKey('WEAPON_ASSAULTRIFLE'))] = 'weapon_assaultrifle',
    [tostring(GetHashKey('WEAPON_ASSAULTRIFLE_MK2'))] = 'weapon_assaultrifle_mk2',
}

function GetListVehicles()
    local itemsList = ItemListInventory()
    local returnVehiclesList = {}
    for k, v in pairs(itemsList) do
        if v.type == "vehicle" then
            table.insert(returnVehiclesList, {
                name = v.label, 
                hash = v.name
            })
        end
    end
    return returnVehiclesList
end

_RegisterNetEvent("ac:detected:spawn", function(entityId)
    local listVehicles = GetListVehicles()
    Citizen.SetTimeout(1000, function()
        local veh = NetworkGetEntityFromNetworkId(entityId)
        local listItems = ItemListInventory()
        local isGoodVehicle = false
        if DoesEntityExist(veh) and IsEntityAVehicle(veh) and not IsEntityDead(veh) then
            if GetPedInVehicleSeat(veh, -1) == PlayerPedId() then
                for _,car in pairs(listItems) do
                    local model = GetEntityModel(veh)
                    if GetHashKey(_) == model then
                        isGoodVehicle = true
                    end
                end

                local plateVeh = GetVehicleNumberPlateText(veh)
                if not string.find(plateVeh, "GUILD") then 
                    DeleteEntity(veh)
                    Wait(1000)
                    -- Tse("ac:detected", "FAKE VEHICLE")
                end

                if not isGoodVehicle then 
                    DeleteEntity(veh)
                    Wait(1000)
                    -- Tse("ac:detected", "FAKE VEHICLE")
                end
            else
                for _,car in pairs(listItems) do
                    local model = GetEntityModel(veh)
                    if GetHashKey(_) == model then
                        isGoodVehicle = true
                    end
                end

                local plateVeh = GetVehicleNumberPlateText(veh)
                if not string.find(plateVeh, "GUILD") then 
                    DeleteEntity(veh)
                    Wait(1000)
                    -- Tse("ac:detected", "FAKE VEHICLE")
                end

                if not isGoodVehicle then 
                    DeleteEntity(veh)
                    Wait(1000)
                    -- Tse("ac:detected", "FAKE VEHICLE")
                end
            end

        end
    end)
end)

function GetWeaponNameFromHash(hash)
    hash = tostring(hash)
    return WeaponNames[hash] or "unknown_weapon_" .. hash
end

-- local listArenaWeapon = {
--     [GetHashKey("weapon_specialcarbine")] = true,
--     [GetHashKey("weapon_assaultrifle_mk2")] = true,
--     [GetHashKey("weapon_specialcarbine_mk2")] = true,
--     [GetHashKey("weapon_assaultrifle_mk2")] = true,
    
-- }

function IsArenaWeapon(weapon) 
    local currentArena = ListArena
    if currentArena then 

        if currentArena.items then 
            for k, v in pairs(currentArena.items) do 
                if v == weapon then 
                    return true
                end
            end
        end
    end
    return false
end

function RemoveWeaponIfDontHave()
    local pPed = PlayerPedId()
    local pWeapon = GetSelectedPedWeapon(pPed)
    local pWeaponHashStr = tostring(pWeapon)
    local pWeaponName = WeaponNames[pWeaponHashStr]
    local pInv = FormatItems(PlayerItems["inventory"])
    print("REMOVE WEAPON", pWeaponName, pWeapon, pWeaponHashStr, GetHashKey("weapon_unarmed"))
    for k, v in pairs(pInv) do 
        print(v.name)
        if v.name == pWeaponName then 
            return
        end
    end
    print("REMOVE WEAPON 2", pWeaponName, pWeapon, pWeaponHashStr, GetHashKey("weapon_unarmed"))
    RemoveWeaponFromPed(pPed, pWeapon)
end

Citizen.CreateThread(function()
    while true do 
        local time = 5000 
        local pPed = PlayerPedId()
        local pWeapon = GetSelectedPedWeapon(pPed)
        local pWeaponHashStr = tostring(pWeapon)
        local pWeaponName = WeaponNames[pWeaponHashStr]
        local pInvehicle = IsPedInAnyVehicle(pPed, false)
        local isDead = IsEntityDead(pPed) 
        local player = GM.Player:Get()
        
        if not pWeaponName and pWeapon ~= GetHashKey("WEAPON_UNARMED") then
            pWeaponName = GetWeaponNameFromHash(pWeapon)
        end

        local pInv = FormatItems(PlayerItems["inventory"])
        
        if pInv and pWeaponName and pWeaponName ~= "weapon_unarmed" then 
            local hasWeapon = false
            for k, v in pairs(pInv) do 
                if v.name == pWeaponName then 
                    hasWeapon = true
                    break
                end
            end
            local itemsName = FoundItemInConfig(tostring(pWeaponName)) 

            if string.find(pWeaponName, "unknown_weapon_") then 
                hasWeapon = true
            end


            if GM.Player.InGunrace then
                local weaponn = GetWeaponGunrace(GM.Player.InGunraceKills)
                if weaponn ~= pWeaponName then
                    RemoveWeaponFromPed(pPed, pWeapon)
                    SetCurrentPedWeapon(pPed, GetHashKey(weaponn), true)
                    hasWeapon = false
                else 
                    hasWeapon = true
                end
            end

            if IsArenaWeapon(pWeaponName) then
                if GM.Player.InFFA then
                    hasWeapon = true
                else 
                    hasWeapon = false
                end
            end 

            if IsPedReloading(pPed) then
                hasWeapon = true
            end

            if GM.Player.InFarm then 
                hasWeapon = true
            end

            if player.Dead then 
                hasWeapon = true
            end

            if isDead then 
                hasWeapon = true
            end

            if not hasWeapon then
                -- Tse("ac:detected", "FAKE WEAPON")
                RemoveAllPedWeapons(PlayerPedId(), true)
                SetCurrentPedWeapon(PlayerPedId(), GetHashKey("WEAPON_UNARMED"), true)
            end
        end
        Wait(time)
    end
end)

BypassTeleport = false

function SetBypassTeleport(bool)
    BypassTeleport = bool
end

exports("SetBypassTeleport", SetBypassTeleport) 

function CheckTeleport()
    if BypassTeleport then return end
    local ped = PlayerPedId()
    local initialCoords = GetEntityCoords(ped)
    local isInVehicle = IsPedInAnyVehicle(ped, false)
    local isFalling = IsPedFalling(ped)
    local isInAir = IsPedInParachuteFreeFall(ped) or not IsPedOnFoot(ped) or GetEntityHeightAboveGround(ped) > 5.0
    Citizen.Wait(3000)
    
    local currentCoords = GetEntityCoords(ped)
    local distance = #(initialCoords - currentCoords)
    local maxAllowedDistance = 20.0
    
    if not isInVehicle and not isFalling and not isInAir and distance > maxAllowedDistance then
        print("DIST " .. distance)
        
        SetEntityCoords(ped, initialCoords.x, initialCoords.y, initialCoords.z, true, false, false, false)
        
        ShowAboveRadarMessage("~r~Rolling back to initial position")
    end
end

Citizen.CreateThread(function()
    while true do
        Citizen.Wait(1000)
        local listItems = ItemListInventory()
        local isGoodVehicle = false
        if IsPedInAnyVehicle(PlayerPedId(), true) then
            local veh = GetVehiclePedIsIn(PlayerPedId(), false)
            if DoesEntityExist(veh) and IsEntityAVehicle(veh) and not IsEntityDead(veh) then
                if GetPedInVehicleSeat(veh, -1) == PlayerPedId() then
                    for _,car in pairs(listItems) do
                        local model = GetEntityModel(veh)
                        if GetHashKey(_) == model then
                            isGoodVehicle = true
                        end
                    end

                    local plateVeh = GetVehicleNumberPlateText(veh)
                    if not string.find(plateVeh, "GUILD") then 
                        DeleteEntity(veh)
                        Wait(1000)
                        -- Tse("ac:detected", "FAKE VEHICLE")
                    end

                    if not isGoodVehicle then 
                        DeleteEntity(veh)
                        Wait(1000)
                        -- Tse("ac:detected", "FAKE VEHICLE")
                    end
                end
            end
        end
    end
end)